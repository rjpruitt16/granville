name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    name: Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build
        run: zig build

      - name: Build Release
        run: zig build -Doptimize=ReleaseFast

      - name: Run Zig Tests
        run: zig build test

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: pip install poetry

      - name: Install Python dependencies
        run: poetry install

      - name: Build Granville
        run: zig build -Doptimize=ReleaseFast

      - name: Install llama driver
        run: ./zig-out/bin/granville driver install granville-llama

      - name: Debug driver install
        run: |
          echo "=== Driver directory contents ==="
          ls -la ~/.granville/drivers/granville-llama/ || echo "Driver directory not found"
          echo "=== Driver json ==="
          cat ~/.granville/drivers/granville-llama/driver.json || echo "No driver.json"
          echo "=== Shared library dependencies ==="
          ldd ~/.granville/drivers/granville-llama/libgranville_llama.so || echo "ldd failed"
          echo "=== File type ==="
          file ~/.granville/drivers/granville-llama/libgranville_llama.so || echo "file command failed"

      - name: Download test model
        run: |
          mkdir -p ~/.granville/models
          curl -L -o ~/.granville/models/tinyllama-1.1b-chat-v1.0.Q4_K_M.gguf \
            "https://huggingface.co/TheBloke/TinyLlama-1.1B-Chat-v1.0-GGUF/resolve/main/tinyllama-1.1b-chat-v1.0.Q4_K_M.gguf"

      - name: Test driver loading
        run: |
          echo "=== Testing driver load with LD_DEBUG ==="
          LD_DEBUG=libs ./zig-out/bin/granville driver list 2>&1 | head -50 || true

      - name: Start Granville server
        run: |
          ./zig-out/bin/granville serve ~/.granville/models/tinyllama-1.1b-chat-v1.0.Q4_K_M.gguf &
          sleep 10  # Wait for model to load

      - name: Run integration tests
        run: poetry run python tests/integration_test.py

      - name: Run ranking tests
        run: poetry run python tests/test_ranking.py

  cross-compile:
    name: Cross Compile
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build for Linux x86_64
        run: zig build -Dtarget=x86_64-linux-gnu -Doptimize=ReleaseFast

      - name: Build for Linux ARM64
        run: zig build -Dtarget=aarch64-linux-gnu -Doptimize=ReleaseFast

      - name: Build for Windows x86_64
        run: zig build -Dtarget=x86_64-windows-gnu -Doptimize=ReleaseFast
